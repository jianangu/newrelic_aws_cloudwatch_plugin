#! /usr/bin/env ruby

#
# This agent pulls data from AWS CloudWatch and ships it to New Relic.
# Supports:
#   - EC2
#
# Sean Porter (portertech@hw-ops.com)
# 2013-04-23
#

require "rubygems"
require "bundler/setup"

require "newrelic_plugin"

module AWSCloudWatch

  class Agent < NewRelic::Plugin::Agent::Base

    agent_guid "com.newrelic.aws_cloudwatch"
    agent_version "0.0.1"
    agent_config_options :access_key # AWS access key
    agent_config_options :secret_key # AWS secret key
    agent_config_options :region     # AWS region
    agent_human_labels("AWS CloudWatch") { "AWS CloudWatch metrics" }

    def poll_cycle
      x = Time.now.to_f * 1000 * Math::PI * 2
      report_metric "SIN",     "Value", Math.sin(x) + 1.0
      report_metric "COS",     "Value", Math.cos(x) + 1.0
      report_metric "BIASSIN", "Value", Math.sin(x) + 5.0
    end

  end

  #
  # Register this agent with the component.
  #
  NewRelic::Plugin::Setup.install_agent :aws_cloudwatch, AWSCloudWatch

  #
  # Launch the agent; this never returns.
  #
  NewRelic::Plugin::Run.setup_and_run

end
